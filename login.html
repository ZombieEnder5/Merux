<!DOCTYPE html>
<html>
	<head>
	</head>
	<body>
		<script src="shared/defaultLoader.js"></script>
		<div id="site-window">
			<p class="warning">Warning: 30 days after logging in, you will be logged out automatically.</p>
			<section class="center-vertical-flex">
				<section class="login-section">
					<h1>Login</h1>
					<hr />
					<p>Username: </p>
					<input type="email" id="username" />
					<div class="side-to-side">
						<p>Password:</p>
						<input type="password" id="password" />
						<button style="color:black;" id="password-toggler">Show Password</button>
					</div>
					<br/>
					<button id="submit" type="submit" style="color:black;">Submit</button>
					<br />
					<br />
					<br />
					<p hidden="true" id="result">Please wait...</p>
				</section>
			</section>
		</div>
		<script>
			window.addEventListener('load', function () {
				const toggle = document.getElementById('password-toggler');
				const put = document.getElementById('password');
				toggle.addEventListener('mousedown', function () {
					put.type = 'text';
				});
				toggle.addEventListener('mouseup', function () {
					put.type = 'password';
				});
				toggle.addEventListener('mouseleave', function () {
					put.type = 'password';
				});
			});
		</script>
		<script type="module">
			import { setCookie, getCookie } from './cookies.js';
			window.addEventListener('load', function () {
				if (getCookie('username') != null && getCookie('password') != null)
					window.location.replace('index.html');
				const submit = document.getElementById('submit');
				const output = document.getElementById('result');
				const userPrompt = document.getElementById('username');
				const passPrompt = document.getElementById('password');
				function abort() {
					output.innerHTML = 'Operation failed. Please wait a few minutes and try again. If this issue persists, contact <a href="ZombieEnder5@proton.me">ZombieEnder5@proton.me</a>.';
					userPrompt.disabled = false;
					passPrompt.disabled = false;
					submit.hidden = false;
				}
				submit.addEventListener('click', function () {
					submit.hidden = true;
					output.hidden = false;
					output.innerHTML = 'Please wait...';
					userPrompt.disabled = true;
					passPrompt.disabled = true;
					try {
						var url = new URL('https://ZombieEnder5.pythonanywhere.com/can_login');
						var username = userPrompt.value;
						var password = passPrompt.value
						url.searchParams.set('username', username);
						url.searchParams.set('password', password);
						fetch(url, { mode: 'cors' }).then((v) => {
							return v.text();
						}).then((x) => {
							if (x == 1) {
								setCookie('username', username, 30);
								setCookie('password', password, 30);
								location.reload();
								return;
							}
							output.innerHTML = 'Incorrect username or password.';
							userPrompt.disabled = false;
							passPrompt.disabled = false;
							submit.hidden = false;
						}).catch(e => {abort();});
					} catch (e) {
						abort();
					}
				});
			});
		</script>
	</body>
</html>